<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survey App (Smart Save)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:300,400,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* Setup Full Screen */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Sarabun', sans-serif; overflow: hidden; background: #eee; }
        #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; background: #ddd; }

        /* Top Bar */
        #top-bar {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; flex-direction: column; gap: 8px;
        }
        .row-control { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Sarabun'; font-size: 14px; background: white; }

        /* Floating Buttons */
        .fab-container {
            position: absolute; bottom: 200px; right: 15px;
            display: flex; flex-direction: column; gap: 15px; z-index: 900;
        }
        .fab-btn {
            width: 55px; height: 55px; border-radius: 50%; background: white; color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: pointer;
        }
        .fab-btn:active { transform: scale(0.95); }
        #fab-refresh { background: #27ae60; color: white; }
        #fab-find { background: #ffc107; }
        #fab-location.active-follow { background: #3498db; color: white; border: 2px solid white; }

        /* Bottom Sheet */
        #bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; background: white;
            border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            z-index: 1001; transform: translateY(100%); transition: transform 0.3s ease-out;
            max-height: 70vh; overflow-y: auto;
        }
        #bottom-sheet.active { transform: translateY(0); }
        .sheet-content { padding: 20px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; color: white; }
        .bg-red { background: #e74c3c; } .bg-orange { background: #e67e22; } .bg-green { background: #27ae60; } .bg-gray { background: #95a5a6; }
        
        textarea { width: 100%; height: 70px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; font-family: 'Sarabun'; margin: 10px 0; box-sizing: border-box; font-size: 16px; }
        
        /* Buttons */
        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; margin-top: 5px; cursor: pointer; }
        .btn-blue { background: #3498db; } .btn-green { background: #27ae60; } .btn-orange { background: #f39c12; } .btn-gray { background: #7f8c8d; } .btn-red { background: #e74c3c; }
        .btn-google { background: white; color: #4285F4; border: 2px solid #4285F4; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .action-row { display: flex; gap: 10px; margin-top: 5px; } .action-row button { flex: 1; }
        
        .leaflet-routing-container { display: none !important; }
        .parcel-label { background: transparent; border: none; box-shadow: none; font-weight: bold; text-shadow: 1px 1px 0 #fff; font-size: 12px; color: #333; }
        .parcel-label-gray { color: #999 !important; text-shadow: none; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="row-control">
            <div><i class="fas fa-map-marked-alt"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à (Pro)</div>
            <div style="font-size:12px;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="txt-remain" style="color:red">0</span> / <span id="txt-total">0</span></div>
        </div>
        <select id="filter-amphoe" onchange="applyFilter()">
            <option value="all">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
        </select>
    </div>

    <div class="fab-container">
        <div id="fab-refresh" class="fab-btn" onclick="fetchDataFromSheet()">
            <i class="fas fa-sync-alt"></i>
        </div>
        <div id="fab-location" class="fab-btn" onclick="toggleFollowMode()">
            <i class="fas fa-location-arrow"></i>
        </div>
        <div id="fab-find" class="fab-btn" onclick="findNextJob()">
            <i class="fas fa-search-location"></i>
        </div>
    </div>

    <div id="map"></div>

    <div id="bottom-sheet">
        <div class="sheet-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>
                    <div id="sheet-name" style="font-size:18px; font-weight:bold;">...</div>
                    <div id="sheet-loc" style="font-size:12px; color:#666;">...</div>
                </div>
                <div onclick="closeSheet()" style="font-size:20px; color:#999; cursor:pointer;"><i class="fas fa-times"></i></div>
            </div>
            <span id="sheet-status" class="status-badge bg-gray">...</span>
            <div id="sheet-body" style="margin-top:15px;">...</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        // ‚úÖ URL Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyIT8RhB1Ea9HRjVAmjy46amGTjWt5rZVDpmqiGbZkjitiWS5UDHwxyZMiOzR-cNvfV/exec'; 

        var map = L.map('map', { zoomControl: false }).setView([13.7563, 100.5018], 10);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(map);

        var markers = [];
        var parcelsData = [];
        var routingControl = null;
        var userMarker = null;
        var myJobId = null;
        var isMapFollowing = false;
        var currentFilter = 'all';

        var icons = {
            waiting: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            booked: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            done: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            gray: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            user: L.divIcon({ className: 'user', html: '<div style="background:#2980b9;width:22px;height:22px;border-radius:50%;border:3px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>', iconSize: [26,26] })
        };

        function fetchDataFromSheet() {
            fetch(APPS_SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                parcelsData = data.map(item => {
                    if (!item.status || item.status.toString().trim() === "") {
                        item.status = 'waiting';
                    } else {
                        item.status = item.status.toString().toLowerCase();
                    }
                    return item;
                });
                updateFilterDropdown();
                renderMarkers();
                updateStats();
                startGPS();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error);
            });
        }
        
        window.onload = fetchDataFromSheet;

        function updateFilterDropdown() {
            var select = document.getElementById('filter-amphoe');
            var oldVal = select.value;
            var amphoes = [...new Set(parcelsData.map(item => item.amphoe))].filter(Boolean).sort();
            select.innerHTML = '<option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
            amphoes.forEach(amphoe => {
                var option = document.createElement('option');
                option.value = amphoe;
                option.text = "‡∏≠." + amphoe;
                select.appendChild(option);
            });
            if(amphoes.includes(oldVal)) select.value = oldVal;
        }

        function applyFilter() {
            currentFilter = document.getElementById('filter-amphoe').value;
            renderMarkers();
            var activeMarkers = markers.filter(m => {
                var p = parcelsData.find(d => d.id == m.parcelId);
                return currentFilter === 'all' || p.amphoe === currentFilter;
            });
            if(activeMarkers.length > 0) {
                var group = new L.featureGroup(activeMarkers);
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            }
        }

        function renderMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            parcelsData.forEach(parcel => {
                var isInFilter = (currentFilter === 'all' || parcel.amphoe == currentFilter);
                var currentStatus = parcel.status || 'waiting'; 
                var iconType = isInFilter ? (icons[currentStatus] || icons.waiting) : icons.gray;
                
                var marker = L.marker([parcel.lat, parcel.lng], {icon: iconType, opacity: isInFilter ? 1 : 0.6 }).addTo(map);
                
                var labelClass = isInFilter ? 'parcel-label' : 'parcel-label parcel-label-gray';
                marker.bindTooltip(String(parcel.name), { permanent: true, direction: 'top', className: labelClass });
                
                marker.on('click', () => { 
                    if (!isInFilter) alert(`‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏≠.${parcel.amphoe})`);
                    openBottomSheet(parcel.id); 
                });
                marker.parcelId = parcel.id;
                markers.push(marker);
            });
        }

        // --- Core: Save to Sheet (Smart Logic) ---
        window.confirmSave = function(id) {
            var note = document.getElementById('inp-note').value.trim(); // ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            var status = 'done'; // ‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à

            // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ: ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Waiting ‡πÑ‡∏´‡∏°
            if (!note) {
                if(confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à' (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    status = 'waiting';
                } else {
                    return; // ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡πá‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô done ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
            saveToSheet(id, note, status);
        }

        function saveToSheet(id, note, status) {
            // Optimistic Update
            var p = parcelsData.find(d => d.id == id);
            p.note = note;
            p.status = status;
            
            renderMarkers();
            updateStats();
            closeSheet();
            
            if ((status === 'waiting' || status === 'done') && routingControl) { 
                map.removeControl(routingControl); 
                routingControl = null; 
            }
            if (status !== 'booked') { myJobId = null; }

            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, note: note, status: status })
            }).then(() => {
                console.log("Updated sheet successfully");
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            }).catch(err => {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î?): " + err);
            });
        }

        window.cancelBooking = function(id) {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                var p = parcelsData.find(d => d.id == id);
                saveToSheet(id, p.note, 'waiting');
            }
        }

        // --- Workflow ---
        window.findNextJob = function() {
            if(!userMarker) { alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤ GPS..."); return; }
            if(myJobId) { alert("‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); openBottomSheet(myJobId); return; }

            var waiting = parcelsData.filter(p => {
                var matchFilter = (currentFilter === 'all' || p.amphoe == currentFilter);
                return p.status === 'waiting' && matchFilter;
            });

            if(waiting.length === 0) { 
                alert(currentFilter === 'all' ? "‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!" : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ô‡∏µ‡πâ"); return; 
            }

            var nearest = waiting.reduce((prev, curr) => {
                var pD = userMarker.getLatLng().distanceTo([prev.lat, prev.lng]);
                var cD = userMarker.getLatLng().distanceTo([curr.lat, curr.lng]);
                return cD < pD ? curr : prev;
            });
            startNavigation(nearest.id);
            openBottomSheet(nearest.id);
        }

        window.startNavigation = function(id) {
            if (myJobId !== null && myJobId !== id) { alert("‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà"); return; }
            myJobId = id;
            var p = parcelsData.find(d => d.id == id);
            p.status = 'booked'; 
            renderMarkers();
            calculateRoute(p.lat, p.lng);
            isMapFollowing = true;
            updateFollowButton();
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Booked) ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
            saveToSheet(id, p.note, 'booked'); 
            openBottomSheet(id);
        }

        // --- UI Logic ---
        function openBottomSheet(id) {
            var p = parcelsData.find(d => d.id == id);
            document.getElementById('sheet-name').innerText = p.name;
            document.getElementById('sheet-loc').innerText = `‡∏≠.${p.amphoe} ‡∏ï.${p.tambon}`;
            
            var badge = document.getElementById('sheet-status');
            var body = document.getElementById('sheet-body');
            var html = '';
            var currentStatus = p.status || 'waiting';

            if (currentStatus === 'waiting') {
                badge.className = 'status-badge bg-red'; badge.innerText = '‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à';
                html = `<button class="btn-full btn-blue" onclick="startNavigation(${id})">üìç ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>`;
            
            } else if (currentStatus === 'booked') {
                badge.className = 'status-badge bg-orange'; badge.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
                html = `<button class="btn-full btn-google" onclick="openGoogle(${id})"><i class="fas fa-map-marked-alt"></i> Google Maps</button>
                        <label style="font-size:12px; color:#666; margin-top:10px; display:block;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</label>
                        <textarea id="inp-note" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">${p.note || ''}</textarea>
                        <div class="action-row">
                            <button class="btn-full btn-red" onclick="cancelBooking(${id})">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button class="btn-full btn-green" onclick="confirmSave(${id})">üíæ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>
                        </div>`;
            } else {
                badge.className = 'status-badge bg-green'; badge.innerText = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
                html = `<label style="font-size:12px; color:#666;">‚úÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <textarea id="inp-note" disabled>${p.note || ''}</textarea>
                        <div id="div-edit-actions">
                            <button class="btn-full btn-gray" onclick="enableEditMode()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                        <div id="div-save-actions" style="display:none;">
                            <button class="btn-full btn-green" onclick="confirmSave(${id})">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </div>`;
            }
            body.innerHTML = html;
            document.getElementById('bottom-sheet').classList.add('active');
            isMapFollowing = false; updateFollowButton();
            map.panTo([p.lat, p.lng]);
        }

        function closeSheet() { document.getElementById('bottom-sheet').classList.remove('active'); }
        
        window.enableEditMode = function() {
            document.getElementById('inp-note').disabled = false;
            document.getElementById('div-edit-actions').style.display = 'none';
            document.getElementById('div-save-actions').style.display = 'block';
        }

        window.openGoogle = function(id) {
            var p = parcelsData.find(d => d.id == id);
            window.open(`http://googleusercontent.com/maps.google.com/maps?q=${p.lat},${p.lng}`, '_blank');
        }

        // --- GPS & Route ---
        function startGPS() {
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(p => {
                    var lat = p.coords.latitude, lng = p.coords.longitude;
                    if(!userMarker) {
                        userMarker = L.marker([lat, lng], {icon: icons.user}).addTo(map);
                        map.setView([lat, lng], 16);
                        isMapFollowing = true; updateFollowButton();
                    } else {
                        userMarker.setLatLng([lat, lng]);
                    }
                    if(isMapFollowing) map.setView([lat, lng], 18);
                }, null, {enableHighAccuracy: true});
            }
        }

        function calculateRoute(lat, lng) {
            if(routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [userMarker.getLatLng(), L.latLng(lat, lng)],
                createMarker: function() { return null; },
                lineOptions: { styles: [{color: '#2980b9', weight: 6}] },
                addWaypoints: false, show: false,
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
            }).addTo(map);
        }

        window.toggleFollowMode = function() {
            isMapFollowing = !isMapFollowing;
            if(isMapFollowing && userMarker) map.setView(userMarker.getLatLng(), 18);
            updateFollowButton();
        }

        function updateFollowButton() {
            var btn = document.getElementById('fab-location');
            btn.className = isMapFollowing ? 'fab-btn active-follow' : 'fab-btn';
        }
        map.on('dragstart', () => { if(isMapFollowing) { isMapFollowing = false; updateFollowButton(); }});

        function updateStats() {
            var done = parcelsData.filter(d => d.status === 'done').length;
            document.getElementById('txt-remain').innerText = parcelsData.length - done;
            document.getElementById('txt-total').innerText = parcelsData.length;
        }
    </script>
</body>
</html>
