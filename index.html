<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏û‡∏±‡∏™‡∏î‡∏∏ (Voice Command)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Sarabun', 'sans-serif'] }, colors: { gov: '#0f5132', gold: '#d4af37' } } } }
    </script>
    <style>
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; background: white; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; transition: all 0.2s; }
        .fab-btn:active { transform: scale(0.95); }
        .fab-active { background: #3b82f6 !important; color: white !important; }
        #bottom-sheet { transform: translateY(100%); transition: transform 0.3s ease-out; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); }
        #bottom-sheet.active { transform: translateY(0); }
        .leaflet-routing-container { display: none !important; }
        .cursor-crosshair { cursor: crosshair !important; }
        
        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡∏ï‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á */
        .mic-listening { background-color: #e74c3c !important; color: white !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 overflow-hidden">

    <div id="login-container" class="min-h-screen flex items-center justify-center p-4 absolute inset-0 z-[2000] bg-gray-100">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-gov">
            <div class="text-center mb-6"><h1 class="text-2xl font-bold text-gov">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1></div>
            <form id="loginForm" class="space-y-4">
                <div><input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" class="w-full px-4 py-2 border rounded-lg" required></div>
                <div><input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-2 border rounded-lg" required></div>
                <select id="userRole" class="w-full px-4 py-2 border rounded-lg">
                    <option value="assessor">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (Assessor)</option>
                    <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Normal)</option>
                </select>
                <button type="submit" class="w-full bg-gov text-white font-bold py-3 rounded-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen flex flex-col">
        <nav class="bg-gov text-white px-4 py-3 flex justify-between items-center shadow-md z-[1001]">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-map-location-dot text-gold text-xl"></i>
                <h1 class="font-bold text-lg hidden sm:block">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</h1>
                <span id="mode-display" class="ml-2 bg-green-800 text-gold text-xs font-bold rounded-lg px-2 py-1 border border-green-600"></span>
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                <span id="display-name" class="font-medium text-sm"></span>
                <span id="display-role" class="bg-gold text-gov text-xs px-2 py-1 rounded-full font-bold"></span>
                <button onclick="logout()" class="bg-red-600 px-3 py-1.5 rounded-lg text-sm"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </nav>

        <div id="valuation-tools" class="hidden bg-white shadow-md z-[1000] px-4 py-2 flex gap-2 items-center flex-wrap">
            <span class="text-sm font-bold text-gray-600 hidden sm:block">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</span>
            <label class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded-lg cursor-pointer"><i class="fa-solid fa-file-import"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ <input type="file" id="import-file" accept=".json,.geojson,.csv,.xlsx,.xls" class="hidden" onchange="importMultiFormatJob(event)"></label>
            <button onclick="toggleAddPinMode()" id="btn-add-pin" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 px-3 rounded-lg"><i class="fa-solid fa-map-pin"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
            <button onclick="clearValuationJob()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2 px-3 rounded-lg"><i class="fa-solid fa-trash"></i> ‡∏•‡πâ‡∏≤‡∏á</button>
            <button onclick="exportValuationJob()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded-lg ml-auto"><i class="fa-solid fa-file-export"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <main class="flex-1 relative">
            <div id="map" class="h-full w-full z-0"></div>
            
            <div class="absolute bottom-24 right-4 flex flex-col gap-4 z-[900]">
                <div id="fab-mic" class="fab-btn bg-white" onclick="toggleVoiceCommand()">
                    <i class="fas fa-microphone"></i>
                </div>
                <div id="fab-location" class="fab-btn" onclick="toggleFollowMode()">
                    <i class="fas fa-location-arrow"></i>
                </div>
            </div>

            <div id="bottom-sheet" class="absolute bottom-0 left-0 w-full bg-white rounded-t-3xl z-[1001] max-h-[85vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h2 id="sheet-title" class="text-xl font-bold text-gov">...</h2>
                            <p id="sheet-subtitle" class="text-sm text-gray-500">...</p>
                        </div>
                        <button onclick="closeSheet()" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <span id="sheet-status" class="inline-block px-3 py-1 rounded-full text-xs font-bold text-white mb-4 bg-gray-500">‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</span>
                    <div id="sheet-body" class="mt-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let map; let userMarker = null; let routingControl = null; let isMapFollowing = false;
        let currentProps = null; let currentLayer = null;
        let isAddingPin = false; 
        const valuationLayerGroup = L.featureGroup();

        const baseMaps = {
            "Google Hybrid": L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 20 }),
            "Google Street": L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20 })
        };

        const icons = {
            waiting: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41] }),
            booked: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', iconSize: [25, 41], iconAnchor: [12, 41] }),
            done: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41] })
        };

        // ================= Voice Command & Speech-to-Text =================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        function setupSpeechRecognition() {
            if (!SpeechRecognition) return console.warn("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
            
            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH'; // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            recognition.continuous = true; // ‡∏ü‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('fab-mic').classList.add('mic-listening');
                speakAlert("‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
                Swal.fire({ toast: true, position: 'top', icon: 'info', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á...', showConfirmButton: false, timer: 2000 });
            };

            recognition.onend = () => {
                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏õ‡∏¥‡∏î) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (isListening) recognition.start();
                else document.getElementById('fab-mic').classList.remove('mic-listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                console.log("‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ß‡πà‡∏≤:", transcript);
                processVoiceCommand(transcript);
            };
        }

        function toggleVoiceCommand() {
            if (!recognition) return Swal.fire('‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Google Chrome)', 'error');
            if (isListening) {
                isListening = false; recognition.stop();
                speakAlert("‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
            } else { recognition.start(); }
        }

        function processVoiceCommand(text) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Bottom Sheet ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const isSheetOpen = document.getElementById('bottom-sheet').classList.contains('active');

            // --- 1. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ---
            if (text.includes("‡∏´‡∏≤‡πÅ‡∏õ‡∏•‡∏á") || text.includes("‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ") || text.includes("‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ")) {
                findNextJob();
            } 
            // --- 2. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á ---
            else if (text.includes("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à") || text.includes("‡∏ô‡∏≥‡∏ó‡∏≤‡∏á") || text.includes("‡πÑ‡∏õ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ")) {
                if (isSheetOpen && currentProps && currentProps.status === 'waiting') {
                    const center = currentLayer.getBounds ? currentLayer.getBounds().getCenter() : currentLayer.getLatLng();
                    startNav(center.lat, center.lng);
                } else { speakAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞"); }
            } 
            // --- 3. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ---
            else if (text.includes("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") || text.includes("‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á")) {
                if (isSheetOpen && currentProps && currentProps.status === 'booked') cancelNav();
            } 
            // --- 4. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏à‡∏ö‡∏á‡∏≤‡∏ô ---
            else if (text.includes("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å") || text.includes("‡∏à‡∏ö‡∏á‡∏≤‡∏ô") || text.includes("‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß")) {
                if (isSheetOpen && currentProps && currentProps.status === 'booked') saveValuation();
            } 
            // --- 5. ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Dictation) ---
            else if (isSheetOpen && currentProps && currentProps.status === 'booked') {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                const noteInput = document.getElementById('inp-note');
                if (noteInput) {
                    noteInput.value += (noteInput.value ? " " : "") + text;
                    Swal.fire({ toast: true, position: 'top', icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 1000 });
                }
            }
        }

        function speakAlert(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH'; window.speechSynthesis.speak(utterance);
            }
        }

        // ================= ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Find Next Job) =================
        function findNextJob() {
            if (!userMarker) {
                speakAlert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Ñ‡πà‡∏∞");
                return startGPS();
            }

            const waitingLayers = [];
            valuationLayerGroup.eachLayer(l => {
                if (l.feature.properties.status === 'waiting') waitingLayers.push(l);
            });

            if (waitingLayers.length === 0) {
                return speakAlert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
            }

            const userPos = userMarker.getLatLng();
            let nearestLayer = null;
            let minDistance = Infinity;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            waitingLayers.forEach(l => {
                const center = l.getBounds ? l.getBounds().getCenter() : l.getLatLng();
                const dist = map.distance(userPos, center);
                if (dist < minDistance) { minDistance = dist; nearestLayer = l; }
            });

            if (nearestLayer) {
                const props = nearestLayer.feature.properties;
                speakAlert("‡∏û‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏ä‡∏∑‡πà‡∏≠ " + (props.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"));
                openValuationSheet(props, nearestLayer);
            }
        }

        // ================= Core System (Login, Init, Sheet, Nav) =================
        document.addEventListener('DOMContentLoaded', () => { const user = JSON.parse(localStorage.getItem('user_session')); if (user) showApp(user); setupSpeechRecognition(); });
        document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); const mockUser = { name: document.getElementById('username').value, role: document.getElementById('userRole').value }; localStorage.setItem('user_session', JSON.stringify(mockUser)); showApp(mockUser); });
        function logout() { localStorage.removeItem('user_session'); window.location.reload(); }

        function showApp(user) {
            document.getElementById('login-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('display-name').innerText = user.name; document.getElementById('display-role').innerText = user.role.toUpperCase();
            document.getElementById('valuation-tools').classList.remove('hidden'); 
            
            if (!map) { 
                map = L.map('map', { center: [17.20, 102.48], zoom: 12, zoomControl: false, layers: [baseMaps["Google Hybrid"]] });
                L.control.zoom({ position: 'topright' }).addTo(map);
                L.control.layers(baseMaps, {}, { position: 'topright', collapsed: true }).addTo(map);
                valuationLayerGroup.addTo(map); 
                setupMapClickHandler(); startGPS(); 
            }
        }

        // UI & Bottom Sheet Logic
        function toggleAddPinMode() { isAddingPin = !isAddingPin; document.getElementById('btn-add-pin').classList.toggle('bg-red-500', isAddingPin); document.getElementById('map').classList.toggle('cursor-crosshair', isAddingPin); }
        function setupMapClickHandler() { map.on('click', function(e) { if (!isAddingPin) return; addGeoJsonToLayer({ type: "Feature", properties: { name: "‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÉ‡∏´‡∏°‡πà", status: "waiting" }, geometry: { type: "Point", coordinates: [e.latlng.lng, e.latlng.lat] } }); toggleAddPinMode(); }); }
        function importMultiFormatJob(event) {
            const file = event.target.files[0]; if (!file) return; const ext = file.name.split('.').pop().toLowerCase(); const reader = new FileReader();
            if (ext === 'json' || ext === 'geojson') { reader.onload = (e) => { clearValuationJob(); addGeoJsonToLayer(JSON.parse(e.target.result)); }; reader.readAsText(file); } 
            else { reader.onload = (e) => { const jsonRows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).SheetNames[0]]); const features = []; jsonRows.forEach(r => { const lat = r.Lat || r.lat || r.Y; const lng = r.Lng || r.lng || r.X; if (lat && lng) features.push({ type: "Feature", properties: { name: r.Name || r.PARCEL_NO || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠", status: "waiting", ...r }, geometry: { type: "Point", coordinates: [parseFloat(lng), parseFloat(lat)] } }); }); if (features.length > 0) { clearValuationJob(); addGeoJsonToLayer({ type: "FeatureCollection", features: features }); } }; reader.readAsArrayBuffer(file); } event.target.value = ''; 
        }

        function addGeoJsonToLayer(geojsonData) { L.geoJSON(geojsonData, { pointToLayer: (f, latlng) => L.marker(latlng, { icon: icons[f.properties.status || 'waiting'] }), style: (f) => ({ color: 'white', weight: 2, fillColor: (f.properties.status === 'booked' ? '#e67e22' : f.properties.status === 'done' ? '#27ae60' : '#e74c3c'), fillOpacity: 0.5 }), onEachFeature: (f, l) => l.on('click', () => openValuationSheet(f.properties, l)) }).addTo(valuationLayerGroup); map.fitBounds(valuationLayerGroup.getBounds()); }

        function openValuationSheet(props, layer) {
            currentProps = props; currentLayer = layer; const center = layer.getBounds ? layer.getBounds().getCenter() : layer.getLatLng();
            document.getElementById('sheet-title').innerText = props.name || "‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à"; document.getElementById('sheet-subtitle').innerText = "‡∏û‡∏¥‡∏Å‡∏±‡∏î: " + center.lat.toFixed(5) + ", " + center.lng.toFixed(5);
            const status = props.status || 'waiting'; const body = document.getElementById('sheet-body');
            if (status === 'waiting') { document.getElementById('sheet-status').className = 'inline-block px-3 py-1 rounded-full text-xs font-bold text-white mb-4 bg-red-500'; document.getElementById('sheet-status').innerText = '‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'; body.innerHTML = `<button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl" onclick="startNav(${center.lat}, ${center.lng})"><i class="fas fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</button>`; } 
            else if (status === 'booked') { document.getElementById('sheet-status').className = 'inline-block px-3 py-1 rounded-full text-xs font-bold text-white mb-4 bg-orange-500'; document.getElementById('sheet-status').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'; body.innerHTML = `<input type="number" id="inp-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" value="${props.price || ''}" class="w-full border-2 border-gov rounded-lg p-3 mb-2 font-bold"><textarea id="inp-note" rows="2" placeholder="‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." class="w-full border p-2 rounded-lg text-sm mb-4">${props.note || ''}</textarea><div class="flex gap-2"><button class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg" onclick="cancelNav()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button><button class="flex-1 bg-green-600 text-white font-bold py-2 rounded-lg" onclick="saveValuation()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button></div>`; } 
            else { document.getElementById('sheet-status').className = 'inline-block px-3 py-1 rounded-full text-xs font-bold text-white mb-4 bg-green-600'; document.getElementById('sheet-status').innerText = '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; body.innerHTML = `<div class="bg-green-50 p-4 rounded-xl text-sm leading-6 border border-green-200"><p><b>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</b> ${props.price ? Number(props.price).toLocaleString() + ' ‡∏ö‡∏≤‡∏ó' : '-'}</p><p><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ${props.note || '-'}</p></div>`; }
            document.getElementById('bottom-sheet').classList.add('active'); map.flyTo([center.lat, center.lng]);
        }

        function closeSheet() { document.getElementById('bottom-sheet').classList.remove('active'); }
        function startNav(lat, lng) { currentProps.status = 'booked'; if (currentLayer.setIcon) currentLayer.setIcon(icons.booked); else currentLayer.setStyle({ fillColor: '#e67e22' }); calcRoute(lat, lng); openValuationSheet(currentProps, currentLayer); speakAlert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡πà‡∏∞"); }
        function cancelNav() { currentProps.status = 'waiting'; if (currentLayer.setIcon) currentLayer.setIcon(icons.waiting); else currentLayer.setStyle({ fillColor: '#e74c3c' }); if(routingControl) map.removeControl(routingControl); openValuationSheet(currentProps, currentLayer); speakAlert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß"); }
        function saveValuation() { const p = document.getElementById('inp-price').value; if (!p) return Swal.fire({ icon: 'warning', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤' }); currentProps.status = 'done'; currentProps.price = p; currentProps.note = document.getElementById('inp-note').value; if (currentLayer.setIcon) currentLayer.setIcon(icons.done); else currentLayer.setStyle({ fillColor: '#27ae60' }); if(routingControl) map.removeControl(routingControl); openValuationSheet(currentProps, currentLayer); speakAlert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); }
        function clearValuationJob() { valuationLayerGroup.clearLayers(); if(routingControl) map.removeControl(routingControl); closeSheet(); }
        function exportValuationJob() { if (valuationLayerGroup.getLayers().length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'warning'); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(valuationLayerGroup.toGeoJSON(), null, 2)], { type: 'application/json' })); a.download = `valuation_job_${new Date().toISOString().split('T')[0]}.json`; a.click(); }

        // GPS
        function calcRoute(lat, lng) { if(routingControl) map.removeControl(routingControl); if(userMarker) routingControl = L.Routing.control({ waypoints: [userMarker.getLatLng(), L.latLng(lat, lng)], createMarker: () => null, show: false }).addTo(map); }
        function startGPS() { navigator.geolocation.watchPosition(p => { const pos = [p.coords.latitude, p.coords.longitude]; if(!userMarker) userMarker = L.marker(pos).addTo(map); else userMarker.setLatLng(pos); if(isMapFollowing) map.setView(pos, 18); }); }
        function toggleFollowMode() { isMapFollowing = !isMapFollowing; if(isMapFollowing && userMarker) map.setView(userMarker.getLatLng(), 18); document.getElementById('fab-location').classList.toggle('fab-active', isMapFollowing); }
    </script>
</body>
</html>
