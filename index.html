<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survey App (iOS Fix)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:300,400,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Sarabun', sans-serif; overflow: hidden; background: #eee; }
        #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; background: #ddd; }

        #top-bar {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; flex-direction: column; gap: 8px;
        }
        .row-control { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .stats-info { font-size: 13px; color: #555; }
        .stats-today { color: #27ae60; font-weight: bold; margin-left: 5px; }

        select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Sarabun'; font-size: 14px; background: white; }

        .fab-container {
            position: absolute; bottom: 200px; right: 15px;
            display: flex; flex-direction: column; gap: 15px; z-index: 900;
        }
        .fab-btn {
            width: 55px; height: 55px; border-radius: 50%; background: white; color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: pointer;
        }
        .fab-btn:active { transform: scale(0.95); }
        
        #fab-download { background: #8e44ad; color: white; }
        #fab-calendar { background: #e67e22; color: white; }
        #fab-refresh { background: #27ae60; color: white; }
        #fab-find { background: #ffc107; }
        #fab-location.active-follow { background: #3498db; color: white; border: 2px solid white; }
        #fab-layer { background: white; color: #333; }
        #fab-gps-fix { background: #e74c3c; color: white; display: none; } /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ GPS */

        .event-dot {
            width: 6px; height: 6px; background-color: #27ae60;
            border-radius: 50%; position: absolute; bottom: 2px; left: calc(50% - 3px);
        }

        #bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; background: white;
            border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            z-index: 1001; transform: translateY(100%); transition: transform 0.3s ease-out;
            max-height: 75vh; overflow-y: auto;
        }
        #bottom-sheet.active { transform: translateY(0); }
        .sheet-content { padding: 20px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; color: white; }
        .bg-red { background: #e74c3c; } .bg-orange { background: #e67e22; } .bg-green { background: #27ae60; } .bg-gray { background: #95a5a6; }
        
        textarea { width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; font-family: 'Sarabun'; margin: 5px 0 10px 0; box-sizing: border-box; font-size: 16px; }
        
        .reason-select {
            width: 100%; padding: 10px; margin-bottom: 5px;
            border: 2px solid #3498db; border-radius: 8px;
            font-family: 'Sarabun'; font-size: 16px; color: #333;
            background-color: #f0f8ff;
        }

        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; margin-top: 5px; cursor: pointer; }
        .btn-blue { background: #3498db; } .btn-green { background: #27ae60; } .btn-orange { background: #f39c12; } .btn-gray { background: #7f8c8d; } .btn-red { background: #e74c3c; }
        .btn-google { background: white; color: #4285F4; border: 2px solid #4285F4; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .action-row { display: flex; gap: 10px; margin-top: 5px; } .action-row button { flex: 1; }
        
        .leaflet-routing-container { display: none !important; }
        .parcel-label { background: transparent; border: none; box-shadow: none; font-weight: bold; text-shadow: 1px 1px 0 #fff; font-size: 12px; color: #333; }
        .parcel-label-gray { color: #999 !important; text-shadow: none; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="row-control">
            <div><i class="fas fa-draw-polygon"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à</div>
            <div class="stats-info">
                ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="txt-remain" style="color:red; font-weight:bold;">0</span> 
                <span style="color:#ccc">|</span>
                ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="txt-today" class="stats-today">0</span>
            </div>
        </div>
        <select id="filter-amphoe" onchange="applyFilter()">
            <option value="all">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
        </select>
    </div>

    <div class="fab-container">
        <div id="fab-gps-fix" class="fab-btn" onclick="requestGPS()">
            <i class="fas fa-satellite-dish"></i>
        </div>

        <div id="fab-download" class="fab-btn" onclick="downloadExcel()">
            <i class="fas fa-file-download"></i>
        </div>
        <div id="fab-calendar" class="fab-btn">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div id="fab-layer" class="fab-btn" onclick="toggleMapLayer()">
            <i class="fas fa-layer-group"></i>
        </div>
        <div id="fab-refresh" class="fab-btn" onclick="fetchDataFromSheet()">
            <i class="fas fa-sync-alt"></i>
        </div>
        <div id="fab-location" class="fab-btn" onclick="toggleFollowMode()">
            <i class="fas fa-location-arrow"></i>
        </div>
        <div id="fab-find" class="fab-btn" onclick="findNextJob()">
            <i class="fas fa-search-location"></i>
        </div>
    </div>

    <div id="map"></div>

    <div id="bottom-sheet">
        <div class="sheet-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>
                    <div id="sheet-name" style="font-size:18px; font-weight:bold;">...</div>
                    <div id="sheet-loc" style="font-size:12px; color:#666;">...</div>
                </div>
                <div onclick="closeSheet()" style="font-size:20px; color:#999; cursor:pointer;"><i class="fas fa-times"></i></div>
            </div>
            <span id="sheet-status" class="status-badge bg-gray">...</span>
            <div id="sheet-body" style="margin-top:15px;">...</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyIT8RhB1Ea9HRjVAmjy46amGTjWt5rZVDpmqiGbZkjitiWS5UDHwxyZMiOzR-cNvfV/exec'; 

        function toLocalISOString(date) {
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        }

        var map = L.map('map', { zoomControl: false }).setView([13.7563, 100.5018], 10);

        var osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' });
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles ¬© Esri' });

        var currentMapType = 'street';
        osmLayer.addTo(map);

        function toggleMapLayer() {
            if (currentMapType === 'street') {
                map.removeLayer(osmLayer);
                map.addLayer(satelliteLayer);
                currentMapType = 'satellite';
            } else {
                map.removeLayer(satelliteLayer);
                map.addLayer(osmLayer);
                currentMapType = 'street';
            }
        }
        
        var markerLayer = L.layerGroup().addTo(map);
        var polygonLayer = L.layerGroup().addTo(map);

        var markers = [];
        var parcelsData = [];
        var routingControl = null;
        var userMarker = null;
        var myJobId = null;
        var isMapFollowing = false;
        var currentFilter = 'all';
        var hasAlerted = false; 
        var ALERT_DISTANCE = 50; 
        var workDates = new Set(); 

        var icons = {
            waiting: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            booked: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            done: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            gray: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            user: L.divIcon({ className: 'user', html: '<div style="background:#2980b9;width:22px;height:22px;border-radius:50%;border:3px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>', iconSize: [26,26] })
        };

        var polyColors = { waiting: '#e74c3c', booked: '#e67e22', done: '#27ae60', gray: '#95a5a6' };

        function speakAlert(text) {
            if ('speechSynthesis' in window) {
                var utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH'; utterance.rate = 1;
                window.speechSynthesis.speak(utterance);
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            }
        }

        function initCalendar() {
            workDates.clear();
            parcelsData.forEach(p => {
                if (p.timestamp && p.status === 'done') {
                    var d = new Date(p.timestamp);
                    if (!isNaN(d.getTime())) {
                        var dateStr = toLocalISOString(d);
                        workDates.add(dateStr);
                    }
                }
            });

            flatpickr("#fab-calendar", {
                disableMobile: "true",
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr, instance) {
                    downloadExcel(dateStr);
                },
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    var dateKey = toLocalISOString(dayElem.dateObj);
                    if (workDates.has(dateKey)) {
                        dayElem.innerHTML += "<span class='event-dot'></span>";
                    }
                }
            });
        }

        function fetchDataFromSheet() {
            var btnIcon = document.querySelector('#fab-refresh i');
            btnIcon.className = 'fas fa-sync-alt fa-spin';
            var noCacheUrl = APPS_SCRIPT_URL + '?t=' + new Date().getTime();

            fetch(noCacheUrl)
            .then(response => response.json())
            .then(data => {
                parcelsData = data.map(item => {
                    if (!item.status) item.status = 'waiting';
                    else item.status = item.status.toString().toLowerCase();
                    return item;
                });
                updateFilterDropdown();
                renderMarkers();
                updateStats();
                
                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î GPS ‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤
                startGPS(); 
                
                initCalendar(); 
                btnIcon.className = 'fas fa-sync-alt';
            })
            .catch(error => {
                console.error('Error:', error);
                btnIcon.className = 'fas fa-sync-alt';
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error);
            });
        }
        window.onload = fetchDataFromSheet;

        function updateFilterDropdown() {
            var select = document.getElementById('filter-amphoe');
            var oldVal = select.value;
            var amphoes = [...new Set(parcelsData.map(item => item.amphoe))].filter(Boolean).sort();
            select.innerHTML = '<option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
            amphoes.forEach(amphoe => {
                var option = document.createElement('option');
                option.value = amphoe; option.text = "‡∏≠." + amphoe;
                select.appendChild(option);
            });
            if(amphoes.includes(oldVal)) select.value = oldVal;
        }

        function applyFilter() {
            currentFilter = document.getElementById('filter-amphoe').value;
            renderMarkers();
            var activeParcels = parcelsData.filter(p => currentFilter === 'all' || p.amphoe === currentFilter);
            if(activeParcels.length > 0) {
                var latlngs = activeParcels.map(p => [p.lat, p.lng]);
                var bounds = L.latLngBounds(latlngs);
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        function renderMarkers() {
            markerLayer.clearLayers();
            polygonLayer.clearLayers(); 
            markers = [];
            
            parcelsData.forEach(parcel => {
                var isInFilter = (currentFilter === 'all' || parcel.amphoe == currentFilter);
                var currentStatus = parcel.status || 'waiting'; 
                var iconType = isInFilter ? (icons[currentStatus] || icons.waiting) : icons.gray;
                
                var marker = L.marker([parcel.lat, parcel.lng], {icon: iconType, opacity: isInFilter ? 1 : 0.6 });
                var labelClass = isInFilter ? 'parcel-label' : 'parcel-label parcel-label-gray';
                marker.bindTooltip(String(parcel.name), { permanent: true, direction: 'top', className: labelClass });
                
                var clickAction = () => { 
                    if (!isInFilter) alert(`‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏≠.${parcel.amphoe})`);
                    openBottomSheet(parcel.id); 
                };

                marker.on('click', clickAction);
                marker.parcelId = parcel.id;
                markerLayer.addLayer(marker);
                markers.push(marker);

                if (parcel.geojson && parcel.geojson.toString().trim() !== "") {
                    try {
                        var rawJson = parcel.geojson.toString();
                        if (rawJson.startsWith('"') && rawJson.endsWith('"')) rawJson = rawJson.slice(1, -1);
                        rawJson = rawJson.replace(/\\"/g, '"');
                        var geoData = JSON.parse(rawJson);
                        var polyColor = isInFilter ? (polyColors[currentStatus] || polyColors.waiting) : polyColors.gray;
                        var poly = L.geoJSON(geoData, {
                            style: { color: polyColor, weight: 2, opacity: isInFilter ? 0.8 : 0.3, fillOpacity: isInFilter ? 0.2 : 0.1 }
                        });
                        poly.on('click', clickAction);
                        polygonLayer.addLayer(poly);
                    } catch(e) {}
                }
            });
        }

        function requestBooking(id) {
            var body = document.getElementById('sheet-body');
            body.innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <p style="font-size:16px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ?</p>
                    <div class="action-row">
                        <button class="btn-full btn-gray" onclick="closeSheet()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button class="btn-full btn-blue" onclick="confirmBooking(${id})">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    </div>
                </div>
            `;
        }

        function confirmBooking(id) {
            if (myJobId !== null && myJobId !== id) { alert("‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà"); return; }
            myJobId = id;
            var p = parcelsData.find(d => d.id == id);
            p.status = 'booked'; 
            hasAlerted = false;
            renderMarkers();
            calculateRoute(p.lat, p.lng);
            isMapFollowing = true;
            updateFollowButton();
            saveToSheet(id, p.note, 'booked'); 
            closeSheet();
            speakAlert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡πà‡∏∞");
        }

        window.findNextJob = function() {
            if(!userMarker) { alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤ GPS..."); requestGPS(); return; }
            if (myJobId) {
                if(confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                    var oldJob = parcelsData.find(d => d.id == myJobId);
                    oldJob.status = 'waiting';
                    if (routingControl) { map.removeControl(routingControl); routingControl = null; }
                    saveToSheet(myJobId, oldJob.note, 'waiting');
                    myJobId = null; hasAlerted = false;
                    setTimeout(() => { searchNearest(); }, 500); 
                } else {
                    openBottomSheet(myJobId); return;
                }
            } else {
                searchNearest();
            }
        }

        function searchNearest() {
            var waiting = parcelsData.filter(p => {
                var matchFilter = (currentFilter === 'all' || p.amphoe == currentFilter);
                return p.status === 'waiting' && matchFilter;
            });
            if(waiting.length === 0) { alert(currentFilter === 'all' ? "‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!" : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ô‡∏µ‡πâ"); return; }
            var nearest = waiting.reduce((prev, curr) => {
                var pD = userMarker.getLatLng().distanceTo([prev.lat, prev.lng]);
                var cD = userMarker.getLatLng().distanceTo([curr.lat, curr.lng]);
                return cD < pD ? curr : prev;
            });
            openBottomSheet(nearest.id);
        }

        window.pickReason = function(val) {
            if(val) document.getElementById('inp-note').value = val;
        }

        function getReasonSelectorHTML() {
            return `
            <select class="reason-select" onchange="pickReason(this.value)">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå --</option>
                <option value="‡πÉ‡∏ä‡πâ‡∏ú‡∏¥‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå">‡πÉ‡∏ä‡πâ‡∏ú‡∏¥‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</option>
                <option value="‡∏ô‡∏≥‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå">‡∏ô‡∏≥‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå</option>
                <option value="‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå">‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå</option>
                <option value="‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á/‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á">‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á/‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</option>
                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>`;
        }

        window.confirmSave = function(id) {
            var note = document.getElementById('inp-note').value.trim();
            var status = 'done';
            if (!note) {
                if(confirm("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) status = 'waiting';
                else return;
            }
            saveToSheet(id, note, status);
        }

        function saveToSheet(id, note, status) {
            var p = parcelsData.find(d => d.id == id);
            p.note = note; p.status = status;
            
            if ((status === 'waiting' || status === 'done') && routingControl) { 
                map.removeControl(routingControl); routingControl = null; 
            }
            if (status !== 'booked') { myJobId = null; hasAlerted = false; }

            renderMarkers();
            updateStats();
            closeSheet();

            fetch(APPS_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, note: note, status: status })
            }).then(() => {
                if(status === 'done') alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            }).catch(err => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err); });
        }

        window.cancelBooking = function(id) {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                var p = parcelsData.find(d => d.id == id);
                saveToSheet(id, p.note, 'waiting');
                alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß");
            }
        }

        function openBottomSheet(id) {
            var p = parcelsData.find(d => d.id == id);
            document.getElementById('sheet-name').innerText = p.name;
            document.getElementById('sheet-loc').innerText = `‡∏≠.${p.amphoe} ‡∏ï.${p.tambon}`;
            
            var badge = document.getElementById('sheet-status');
            var body = document.getElementById('sheet-body');
            var html = '';
            var currentStatus = p.status || 'waiting';

            if (currentStatus === 'waiting') {
                badge.className = 'status-badge bg-red'; badge.innerText = '‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à';
                html = `<button class="btn-full btn-blue" onclick="requestBooking(${id})">üìç ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>`;
            } else if (currentStatus === 'booked') {
                badge.className = 'status-badge bg-orange'; badge.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
                html = `<button class="btn-full btn-google" onclick="openGoogle(${id})"><i class="fas fa-map-marked-alt"></i> ‡πÄ‡∏õ‡∏¥‡∏î Google Maps (‡∏ô‡∏≥‡∏ó‡∏≤‡∏á)</button>
                        <hr style="border:1px solid #eee; margin:10px 0;">
                        <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à</label>
                        ${getReasonSelectorHTML()}
                        <textarea id="inp-note" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...">${p.note || ''}</textarea>
                        <div class="action-row">
                            <button class="btn-full btn-red" onclick="cancelBooking(${id})">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button class="btn-full btn-green" onclick="confirmSave(${id})">üíæ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>
                        </div>`;
            } else {
                badge.className = 'status-badge bg-green'; badge.innerText = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
                html = `<label style="font-size:12px; color:#666;">‚úÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <textarea id="inp-note" disabled>${p.note || ''}</textarea>
                        <div id="div-edit-actions"><button class="btn-full btn-gray" onclick="enableEditMode()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
                        <div id="div-save-actions" style="display:none;">
                            ${getReasonSelectorHTML()}
                            <button class="btn-full btn-green" onclick="confirmSave(${id})">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </div>`;
            }
            body.innerHTML = html;
            document.getElementById('bottom-sheet').classList.add('active');
            isMapFollowing = false; updateFollowButton();
            map.panTo([p.lat, p.lng]);
        }

        function closeSheet() { document.getElementById('bottom-sheet').classList.remove('active'); }
        window.enableEditMode = function() {
            document.getElementById('inp-note').disabled = false;
            document.getElementById('div-edit-actions').style.display = 'none';
            document.getElementById('div-save-actions').style.display = 'block';
        }
        window.openGoogle = function(id) {
            var p = parcelsData.find(d => d.id == id);
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`, '_blank');
        }

        // ‚úÖ iOS GPS FIX: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° GPS ‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
        window.requestGPS = function() {
            startGPS(true);
        }

        function startGPS(force = false) {
            if (!navigator.geolocation) {
                alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
                return;
            }

            var options = {
                enableHighAccuracy: true,
                timeout: 10000, 
                maximumAge: 0   
            };

            navigator.geolocation.watchPosition(
                function(p) {
                    // Success
                    var lat = p.coords.latitude, lng = p.coords.longitude;
                    var userPos = [lat, lng];
                    
                    if(!userMarker) {
                        userMarker = L.marker(userPos, {icon: icons.user}).addTo(map);
                        map.setView(userPos, 16);
                        isMapFollowing = true; updateFollowButton();
                    } else { 
                        userMarker.setLatLng(userPos); 
                    }
                    if(isMapFollowing) map.setView(userPos, 18);

                    // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ GPS ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡πâ‡∏ß
                    document.getElementById('fab-gps-fix').style.display = 'none';

                    // Alert check
                    if (myJobId && !hasAlerted) {
                         var job = parcelsData.find(d => d.id == myJobId);
                         if (job) {
                             var dist = map.distance(userPos, [job.lat, job.lng]);
                             if (dist < ALERT_DISTANCE) { speakAlert("‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞"); hasAlerted = true; }
                         }
                    }
                }, 
                function(err) {
                    // Error
                    console.warn('GPS Error(' + err.code + '): ' + err.message);
                    if (force || err.code === 1) { // 1 = Permission Denied
                         alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ GPS\n‡πÇ‡∏õ‡∏£‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà Settings > Privacy > Location Services > Safari Websites > ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 'While Using'");
                         // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà
                         document.getElementById('fab-gps-fix').style.display = 'flex';
                    }
                }, 
                options
            );
        }

        function calculateRoute(lat, lng) {
            if(routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [userMarker.getLatLng(), L.latLng(lat, lng)],
                createMarker: function() { return null; },
                lineOptions: { styles: [{color: '#2980b9', weight: 6}] },
                addWaypoints: false, show: false,
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
            }).addTo(map);
        }

        window.toggleFollowMode = function() {
            isMapFollowing = !isMapFollowing;
            if(isMapFollowing && userMarker) map.setView(userMarker.getLatLng(), 18);
            updateFollowButton();
        }
        function updateFollowButton() {
            var btn = document.getElementById('fab-location');
            btn.className = isMapFollowing ? 'fab-btn active-follow' : 'fab-btn';
        }
        map.on('dragstart', () => { if(isMapFollowing) { isMapFollowing = false; updateFollowButton(); }});

        function updateStats() {
            var done = parcelsData.filter(d => d.status === 'done').length;
            document.getElementById('txt-remain').innerText = parcelsData.length - done;
            
            var todayStr = toLocalISOString(new Date());
            var todayCount = parcelsData.filter(d => {
                if (d.status !== 'done') return false;
                if (!d.timestamp) return false;
                var dDate = toLocalISOString(new Date(d.timestamp));
                return dDate === todayStr;
            }).length;

            document.getElementById('txt-today').innerText = todayCount;
        }

        function downloadExcel(filterDate = null) {
            var completedParcels = parcelsData.filter(p => p.status === 'done');

            if (completedParcels.length === 0) {
                alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            var exportData = completedParcels;
            var fileNamePrefix = "Report_Done_All";

            if (filterDate) {
                exportData = completedParcels.filter(p => {
                    if (!p.timestamp) return false;
                    var pDate = toLocalISOString(new Date(p.timestamp));
                    return pDate === filterDate;
                });
                
                if (exportData.length === 0) {
                    alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + filterDate + " ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö"); 
                    return; 
                }
                fileNamePrefix = "Report_Done_" + filterDate;
            } else {
                var choice = confirm("‡∏û‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î " + completedParcels.length + " ‡πÅ‡∏õ‡∏•‡∏á\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏Å‡∏î '‡∏ï‡∏Å‡∏•‡∏á' ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡∏Å‡∏î '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô)");
                if (!choice) return;
            }

            var csvContent = "‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á,‡∏≠‡∏≥‡πÄ‡∏†‡∏≠,‡∏ï‡∏≥‡∏ö‡∏•,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n";
            exportData.forEach(function(row) {
                var name = row.name || "-";
                var amphoe = row.amphoe || "-";
                var tambon = row.tambon || "-";
                var status = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"; 
                var note = (row.note || "").replace(/,/g, " ").replace(/\n/g, " ");
                var time = row.timestamp || "-";
                csvContent += `${name},${amphoe},${tambon},${status},${note},${time}\n`;
            });

            var blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            var fileName = fileNamePrefix + ".csv";
            var link = document.createElement("a");
            if (link.download !== undefined) { 
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
